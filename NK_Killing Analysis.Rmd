---
title: "NK_Killing_Mixed_Model"
author: "Akshay Iyer"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_width: 10
    fig_height: 8
    number_sections: false
---

```{r Modeling, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

library(readxl)
library(dplyr)
library(lme4)
library(ggplot2)
library(ggeffects)
library(lmerTest)
library(tidyr)
library(reshape2)
library(limma)
library(edgeR)
library(ggplot2)
library(ggrepel)
library(plotly)
library(tidyverse)
library(emmeans)


data <- read_excel("NK Function Metadata.xlsx")
v_data <- read.csv("Viral_Titres.csv")

########## Clean Column Names and Delete uneeded columns ##############

# Preliminary setup
names(data)[names(data) == "Donor ID"] <- "PID" # Rename column to PID

# Insert a new column "viral load" as the 11th column initialized with NA
data$viral_load <- NA
# This step involves creating a new column order vector
new_order <- c(names(data)[1:10], "viral_load", names(data)[11:(ncol(data)-1)])

# Reorder the dataframe columns according to the new order
data <- data[, new_order]

data$HIV <- ifelse(data$HIV == "positive", "HEI", 
                   ifelse(data$HIV == "negative", "HEU", data$HIV))

# Fix errored entries
data$`age (yrs)` <- as.numeric(data$`age (yrs)`)
data$gender <- as.factor(data$gender)
data$HIV <- as.factor(data$HIV)
data$Group <- as.factor(data$Group)
data$Treatment <- as.factor(data$Treatment)
data$Batch <- as.factor(data$Batch)

data <- data %>%
  mutate(
    Timepoint = if_else(grepl("CE037 V11", `Sample Name`), "12", as.character(Timepoint)),
    `age (yrs)` = if_else(grepl("CE037 V11", `Sample Name`), 0.85, `age (yrs)`)
  )


data <- data %>%
  filter(!(`Sample Name` == "A1 CE023 V1 NK only.fcs" & Batch == "Batch 9"))


######### Add VIral Load Data ###########

# Step 1 & 2: Update "viral load" based on "Group" and "HIV"
data$viral_load[data$Group != "TARA"] <- NA
data$viral_load[data$HIV == "HEU"] <- 0

# Step 3 & 4: Extract and set "viral load" for specific conditions
for (i in 1:nrow(data)) {
  if (data$Group[i] == "TARA" && data$HIV[i] == "HEI") {
    if (data$Timepoint[i] == "12") {
      # Extract from v_data where PID matches and Age is 12
      matched <- v_data[v_data$PID == data$PID[i] & v_data$Age == 12,]
    } else if (data$Timepoint[i] == "Entry" && grepl(" V1", data$`Sample Name`[i])) {
      # Extract from v_data where PID matches and Age is 1
      matched <- v_data[v_data$PID == data$PID[i] & v_data$Age == 1,]
    } else if (data$Timepoint[i] == "Entry" && grepl(" V2", data$`Sample Name`[i])) {
      # Extract from v_data where PID matches and Age is 2
      matched <- v_data[v_data$PID == data$PID[i] & v_data$Age == 2,]
    } else {
      next
    }
    
    # Update the "viral load" if matched entry found
    if (nrow(matched) > 0) {
      data$viral_load[i] <- matched$Viral.Titre[1] # Assuming the first match is taken if multiple
    }
  }
}

# Restore original column names with spaces or special characters as necessary
names(data) <- gsub("viral_load", "viral load", names(data))

data_cleaned <- data %>% select(-c(1, 3, 4))


######### Split Data based on Killing, MFI and Frequency ############

col_names <- names(data_cleaned)
col_names_excluding_killing <- col_names[-((ncol(data_cleaned)-2):ncol(data_cleaned))]

# Identify indices for the shared first 9 columns and the last 3 columns
shared_cols <- 1:10
killing_additional_cols <- (ncol(data_cleaned)-2):ncol(data_cleaned) # Last 3 columns

# Identify columns for MFI and Freq excluding the last three columns
mfi_cols <- grep("Median", col_names_excluding_killing)
freq_cols <- grep("\\(\\%\\)", col_names_excluding_killing, perl = TRUE)

# Map these columns back to the original dataframe's column indices
mfi_indices <- match(col_names_excluding_killing[mfi_cols], col_names)
freq_indices <- match(col_names_excluding_killing[freq_cols], col_names)

# Creating the dataframes
Killing <- data_cleaned[, c(shared_cols, (ncol(data_cleaned)-2):ncol(data_cleaned))]
MFI <- data_cleaned[, unique(c(shared_cols, mfi_indices))]
Freq <- data_cleaned[, unique(c(shared_cols, freq_indices))]


### Clean Frequency Dataset prior to Splitting, and convert % to raw counts ########
names(Freq) <- gsub(" \\| Freq\\. of Parent \\(%\\)", "", names(Freq))
rename_map <- c(
  "Lymphocytes" = "P1",
  "Lymphocytes/Single Cells" = "P2",
  "Lymphocytes/Single Cells/Live" = "P3",
  "Lymphocytes/Single Cells/Live/CD3-Label-" = "P4"
)

# Loop through the rename map and assign new names to Freq dataframe
for(original_name in names(rename_map)) {
  # Check if the original_name exists in the column names of Freq
  if(original_name %in% names(Freq)) {
    # Get the index of the column with the original name
    col_index <- which(names(Freq) == original_name)
    # Assign the new name to the column
    names(Freq)[col_index] <- rename_map[original_name]
  }
}

# Convert percentages to actual values
Freq$P1 <- Freq$Count * (Freq$P1 / 100) # P1 as a percentage of Count
Freq$P2 <- Freq$P1 * (Freq$P2 / 100)    # P2 as a percentage of the new P1 value
Freq$P3 <- Freq$P2 * (Freq$P3 / 100)    # P3 as a percentage of the new P2 value
Freq$P4 <- Freq$P3 * (Freq$P4 / 100)    # P4 as a percentage of the new P3 value
Freq$`Total NK` <- Freq$P4 * (Freq$`Total NK` / 100)    # P4 as a percentage of the new P3 value

str(Freq)
# Step 1: Identify column groups
single_slash_cols <- grep("^Total NK/[^/]+$", names(Freq), value = TRUE)
double_slash_cols <- grep("^Total NK/.+/[^/]+$", names(Freq), value = TRUE)

##### Checking for non-numeric values
# Combine all columns of interest into a single vector
all_cols <- c("Total NK", single_slash_cols, double_slash_cols)

# Identify non-numeric columns from the list
non_numeric_cols <- all_cols[sapply(Freq[all_cols], function(x) !is.numeric(x))]
# Convert identified non-numeric columns to numeric
Freq[non_numeric_cols] <- lapply(Freq[non_numeric_cols], function(x) as.numeric(as.character(x)))

# Verify changes
str(Freq[non_numeric_cols])

# Impute NA Values
# Columns to impute (example; adjust as needed)
columns_to_impute <- c("Total NK", single_slash_cols, double_slash_cols)

# Impute NAs based on the median for the HIV status group
Freq <- Freq %>%
  mutate(across(all_of(columns_to_impute), ~if_else(is.na(.),
                                                    ave(., HIV, FUN = function(x) median(x, na.rm = TRUE)),
                                                    .),
                .names = "{.col}"))


# Step 2: Calculate values for direct subsets of "Total NK"
for(col in single_slash_cols) {
  Freq[[col]] <- Freq[["Total NK"]] * (Freq[[col]] / 100)
}


# Srep 3 Double / cols
for(col in double_slash_cols) {
  # Extract the parent subset name from the column name
  parts <- strsplit(col, "/")[[1]]
  parent_subset_name <- paste(parts[1:length(parts)-1], collapse="/")
  
  # Ensure parent_subset_name is in single_slash_cols or double_slash_cols
  if(parent_subset_name %in% names(Freq)) {
    parent_value <- Freq[[parent_subset_name]]
    Freq[[col]] <- parent_value * (Freq[[col]] / 100)
  }
}

# Update the dataframe column names to reflect the calculated values
names(Freq) <- gsub("Total NK/", "", names(Freq))

### Add Specific Killing to dataframes

Freq$`specific killing` <- Killing$`specific killing`
MFI$`specific killing` <- Killing$`specific killing`

#### Split Datasets for Analysis #####

TARA_Killing <- subset(Killing, Group == "TARA")
TARA_MFI <- subset(MFI, Group == "TARA")
TARA_Freq <- subset(Freq, Group == "TARA")
Florah_Killing <- subset(Killing, Group == "Florah")
Florah_MFI <- subset(MFI, Group == "Florah")
Florah_Freq <- subset(Freq, Group == "Florah")


###### NK KILLING Analysis #############

### Cleaning Dataframe ###

# Removing the 'Group' column from both dataframes
TARA_Killing$Group <- NULL
TARA_Killing <- TARA_Killing %>%
  filter(`specific killing` != "n/a")

# Round the values in the 'specific killing' column to two decimal points
TARA_Killing$`specific killing` <- as.numeric(TARA_Killing$`specific killing`)
TARA_Killing$`specific killing` <- round(TARA_Killing$`specific killing`, 2)

TARA_Killing <- TARA_Killing %>%
  filter(HIV != "HUU")

# Remove Unneeded Columns

TARA_Killing <- TARA_Killing[, -c(ncol(TARA_Killing)-2, ncol(TARA_Killing)-1)]

TARA_Killing <- TARA_Killing[, -which(names(TARA_Killing) == "age (yrs)")]

TARA_Killing <- droplevels(TARA_Killing)




# Standardize the 'viral load' variable because of high values

TARA_Killing$`viral load` <- scale(TARA_Killing$`viral load`)
str(TARA_Killing)

TARA_Killing$Timepoint <- as.factor(TARA_Killing$Timepoint)
TARA_Killing$Timepoint <- relevel(TARA_Killing$Timepoint, ref = "Entry")


#### Fit the mixed effects model for each treatment condition ####

TARA_Killing_model <- lmer(`specific killing` ~ (HIV + Timepoint + gender + Treatment)^2 + (1|PID), data = TARA_Killing)
summary(TARA_Killing_model)
# Define the treatment levels
treatments <- levels(TARA_Killing$Treatment)

for (treatment in treatments) {
  # Create a subset for the current treatment
  subset_data <- subset(TARA_Killing, Treatment == treatment)
  
  # Fit a mixed-effects model for the subset
  model_formula <- as.formula(`specific killing` ~ (HIV + Timepoint + gender + Batch)^2 + (1|PID))
  model <- lmer(model_formula, data = subset_data)
  
  # Print the summary of the model
  print(paste("Model for Treatment:", treatment))
  print(summary(model))
  
  # Optionally, save the model for later use
  assign(paste("TARA_Killing_", gsub("[+]", "", treatment), sep = ""), subset_data, envir = .GlobalEnv)
  assign(paste("TARA_Killing_", gsub("[+]", "", treatment), "_model", sep = ""), model, envir = .GlobalEnv)
}

TARA_Killing$predicted_killing <- predict(TARA_Killing_model, re.form = NA)
TARA_Killing_CEM$predicted_killing <- predict(TARA_Killing_CEM_model, re.form = NA)
TARA_Killing_CEMIL15$predicted_killing <- predict(TARA_Killing_CEMIL15_model, re.form = NA)
TARA_Killing_HUT78$predicted_killing <- predict(TARA_Killing_HUT78_model, re.form = NA)
TARA_Killing_HUT78IL15$predicted_killing <- predict(TARA_Killing_HUT78IL15_model, re.form = NA)
TARA_Killing_K562$predicted_killing <- predict(TARA_Killing_K562_model, re.form = NA)
TARA_Killing_K562IL15$predicted_killing <- predict(TARA_Killing_K562IL15_model, re.form = NA)

###### NK Freq Analysis #############

# Removing the 'Group' column from both dataframes
TARA_Freq$Group <- NULL

# Get all column names
column_names <- names(TARA_Freq)

# Number of columns
n_columns <- length(column_names)

# Move the last column to be the 10th column
# We create a sequence from the first to the (n_columns - 1) to exclude the last column initially,
# then cbind the last column name at the 10th position.
new_order <- c(column_names[-n_columns][1:9], column_names[n_columns], column_names[-n_columns][10:(n_columns-1)])

# Rearrange the dataframe columns based on the new order
TARA_Freq <- TARA_Freq[, new_order]

# Round the values in the 'specific killing' column to two decimal points
TARA_Freq$`specific killing` <- as.numeric(TARA_Freq$`specific killing`)
TARA_Freq$`specific killing` <- round(TARA_Freq$`specific killing`, 2)

TARA_Freq <- TARA_Freq %>%
  filter(HIV != "HUU")

TARA_Freq[, 11:ncol(TARA_Freq)] <- TARA_Freq[, 11:ncol(TARA_Freq)] / TARA_Freq$Count * 100
TARA_Freq[, 11:ncol(TARA_Freq)] <- round(TARA_Freq[, 11:ncol(TARA_Freq)], 3)
TARA_Freq <- TARA_Freq[, !apply(TARA_Freq == 0, 2, all)]
TARA_Freq$`viral load` <- scale(TARA_Freq$`viral load`)

### Differential Abundance analysis
TARA_Freq_DA <- TARA_Freq[, !(names(TARA_Freq) %in% c("Batch", "age (yrs)", "Count", "P1", "P2", "P3", "P4", "specific killing"))]
TARA_Freq_DA$Timepoint <- as.factor(TARA_Freq_DA$Timepoint)
TARA_Freq_DA <- droplevels(TARA_Freq_DA)
covariate_columns <- c("PID", "gender", "HIV", "viral load", "Timepoint", "Treatment")

### Limma
# Initialize a list to store results
results_list <- list()

# Loop over each combination of Treatment and Timepoint
for (treatment in levels(TARA_Freq_DA$Treatment)) {
  for (timepoint in levels(TARA_Freq_DA$Timepoint)) {
    
    # Subset data for current treatment and timepoint
    current_data <- TARA_Freq_DA[TARA_Freq_DA$Treatment == treatment & TARA_Freq_DA$Timepoint == timepoint,]
    names(current_data)[names(current_data) == "viral load"] <- "viral_load"
    current_data <- na.omit(current_data)
    
    # Check if there are enough data points to proceed
    if(nrow(current_data) > 1){
      # Design matrix including intercept
      design <- model.matrix(~ 0+ HIV + gender + viral_load, data = current_data)

      # Voom transformation
      v <- voom(t(current_data[, !(names(current_data) %in% c("PID", "gender", "HIV", "viral_load", "Timepoint", "Treatment"))]), 
                design, plot = FALSE)
      
      # Fit the linear model
      fit <- lmFit(v, design)

      # Contrast for HIV positive vs. negative
      contrast.matrix <- makeContrasts(HIVHEI - HIVHEU, levels=design)
      
      # Apply contrasts
      fit2 <- contrasts.fit(fit, contrast.matrix)
      fit2 <- eBayes(fit2)
      # Store results
      results_list[[paste(treatment, timepoint, sep="_")]] <- topTable(fit2, adjust="BH", number=1000)
      
    }
  }
}
#### Mixed Effects Models ####

filter_top_effects <- function(data_frame) {
  positive_effects <- data_frame %>% 
    arrange(desc(Estimate)) %>% 
    head(35)
  
  negative_effects <- data_frame %>% 
    arrange(Estimate) %>% 
    head(35)
  
  bind_rows(positive_effects, negative_effects)
}
TARA_Freq_M <- TARA_Freq[, !(names(TARA_Freq) %in% c("Batch", "age (yrs)", "Count", "P1", "P2", "P3", "P4"))]

# Initialize an empty list to store intermediate dataframes
merge_treatment_killing <- function(main_df, treatment_df, treatment_name) {
  # Create a unique key by pasting PID and Timepoint
  main_df$key <- paste(main_df$PID, main_df$Timepoint)
  treatment_df$key <- paste(treatment_df$PID, treatment_df$Timepoint)
  
  # Rename the specific killing column in the treatment dataframe
  col_name <- paste0("specific_killing_", treatment_name)
  names(treatment_df)[names(treatment_df) == paste0("specific_killing_", treatment_name)] <- col_name
  
  # Merge based on the unique key
  enriched_df <- left_join(main_df, treatment_df[c("key", col_name)], by = "key")
  
  # Remove the key column to clean up
  enriched_df$key <- NULL
  
  return(enriched_df)
}
unique_treatments <- unique(TARA_Freq_M$Treatment)

# Applying the function for each treatment
TARA_Freq_M_enriched <- TARA_Freq_M

for(treatment in unique_treatments) {
  # Prepare the treatment-specific dataframe
  specific_treatment_df <- TARA_Freq_M %>%
    filter(Treatment == treatment) %>%
    select(PID, Timepoint, `specific killing`) %>%
    mutate(!!paste0("specific_killing_", treatment) := `specific killing`) %>%
    select(-`specific killing`) # We don't need the Treatment column anymore
  
  # Merge this treatment's killing values into the main dataframe
  TARA_Freq_M_enriched <- merge_treatment_killing(TARA_Freq_M_enriched, specific_treatment_df, treatment)
}

# Number of columns in the dataframe
num_cols <- ncol(TARA_Freq_M_enriched)

# Create a vector with the new column order
# First 8 columns + last 8 columns moved to 9th position + remaining columns
new_order <- c(1:8, (num_cols-7):num_cols, 9:(num_cols-8))

# Reorder the columns based on the new order
TARA_Freq_M_enriched <- TARA_Freq_M_enriched[, new_order]

### Subset untreated 
untreated_df <- TARA_Freq_M_enriched %>%
  filter(Treatment == "untreated")
filtered_df <- untreated_df %>%
  filter(!is.na(specific_killing_HUT78) & !is.na(specific_killing_K562))

fixed_part_of_formula <- "~ `viral load` + Timepoint  + gender + HIV + specific_killing_HUT78 + specific_killing_K562 + (1 | PID)"

## HIV Effect

# Initialize lists to store results
models_list <- list()
percentage_columns <- colnames(filtered_df[17:ncol(filtered_df)])

# Loop through each  subset, ensuring column names are correctly handled
for (subset_name in percentage_columns) {
  # Escape subset_name if it contains special characters
  escaped_subset_name <- paste0("`", gsub("/", "\\/", subset_name), "`")
  
  # Construct the formula string with escaped column names
  formula_str <- paste(escaped_subset_name, fixed_part_of_formula)
  
  # Convert the string to a formula
  current_formula <- as.formula(formula_str)
  
  
  # Fit the model using the current formula
  model <- tryCatch({
    lmer(current_formula, data = filtered_df)
  }, error = function(e) {
    cat("Error in fitting model for subset:", subset_name, "\nError message:", e$message, "\n")
    return(NULL)  # Return NULL if there was an error fitting the model
  })
  
  # Store the model if successfully fitted
  if (!is.null(model)) {
    models_list[[subset_name]] <- model
  }
}

# Initialize an empty data frame to store the results
results_df <- data.frame(Subset = character(), Effect = character(), Estimate = numeric(), 
                                   Std.Error = numeric(), P.Value = numeric(), stringsAsFactors = FALSE)

# Loop through each model to extract information
for (subset_name in names(models_list)) {
  model <- models_list[[subset_name]]
  summary_model <- summary(model)
  df <- as.data.frame(summary_model$coefficients)
  df$Subset <- subset_name
  df$Effect <- rownames(df)
  results_df <- rbind(results_df, df)
}

results_df <- results_df %>% 
  rename(Estimate = Estimate, Std.Error = `Std. Error`, P.Value = `Pr(>|t|)`) %>%
  select(Subset, Effect, Estimate, `Std.Error`, P.Value)


#### Mixed Model for k562 and Hut78

HUT78_df <- TARA_Freq_M_enriched %>%
  filter(Treatment == "HUT78")
K562_df <- TARA_Freq_M_enriched %>%
  filter(Treatment == "K562")

h_fixed_part_of_formula <- "~ `viral load` + Timepoint  + gender + HIV + specific_killing_HUT78  + (1 | PID)"
k_fixed_part_of_formula <- "~ `viral load` + Timepoint  + gender + HIV + specific_killing_K562  + (1 | PID)"


# Initialize lists to store results
h_models_list <- list()
k_models_list <- list()

h_percentage_columns <- colnames(HUT78_df[17:ncol(HUT78_df)])
k_percentage_columns <- colnames(K562_df[17:ncol(K562_df)])

### Model for HUT78

# Loop through each  subset, ensuring column names are correctly handled
for (subset_name in h_percentage_columns) {
  # Escape subset_name if it contains special characters
  escaped_subset_name <- paste0("`", gsub("/", "\\/", subset_name), "`")
  
  # Construct the formula string with escaped column names
  formula_str <- paste(escaped_subset_name, h_fixed_part_of_formula)
  
  # Convert the string to a formula
  current_formula <- as.formula(formula_str)
  
  
  # Fit the model using the current formula
  model <- tryCatch({
    lmer(current_formula, data = HUT78_df)
  }, error = function(e) {
    cat("Error in fitting model for subset:", subset_name, "\nError message:", e$message, "\n")
    return(NULL)  # Return NULL if there was an error fitting the model
  })
  
  # Store the model if successfully fitted
  if (!is.null(model)) {
    h_models_list[[subset_name]] <- model
  }
}

# Initialize an empty data frame to store the results
h_results_df <- data.frame(Subset = character(), Effect = character(), Estimate = numeric(), 
                         Std.Error = numeric(), P.Value = numeric(), stringsAsFactors = FALSE)

# Loop through each model to extract information
for (subset_name in names(h_models_list)) {
  model <- models_list[[subset_name]]
  summary_model <- summary(model)
  df <- as.data.frame(summary_model$coefficients)
  df$Subset <- subset_name
  df$Effect <- rownames(df)
  h_results_df <- rbind(h_results_df, df)
}

### Model for K562

### Model for HUT78

# Loop through each  subset, ensuring column names are correctly handled
for (subset_name in k_percentage_columns) {
  # Escape subset_name if it contains special characters
  escaped_subset_name <- paste0("`", gsub("/", "\\/", subset_name), "`")
  
  # Construct the formula string with escaped column names
  formula_str <- paste(escaped_subset_name, k_fixed_part_of_formula)
  
  # Convert the string to a formula
  current_formula <- as.formula(formula_str)
  
  
  # Fit the model using the current formula
  model <- tryCatch({
    lmer(current_formula, data = K562_df)
  }, error = function(e) {
    cat("Error in fitting model for subset:", subset_name, "\nError message:", e$message, "\n")
    return(NULL)  # Return NULL if there was an error fitting the model
  })
  
  # Store the model if successfully fitted
  if (!is.null(model)) {
    k_models_list[[subset_name]] <- model
  }
}

# Initialize an empty data frame to store the results
k_results_df <- data.frame(Subset = character(), Effect = character(), Estimate = numeric(), 
                           Std.Error = numeric(), P.Value = numeric(), stringsAsFactors = FALSE)

# Loop through each model to extract information
for (subset_name in names(k_models_list)) {
  model <- models_list[[subset_name]]
  summary_model <- summary(model)
  df <- as.data.frame(summary_model$coefficients)
  df$Subset <- subset_name
  df$Effect <- rownames(df)
  k_results_df <- rbind(k_results_df, df)
}

####################

k_results_df <- k_results_df %>% 
  rename(Estimate = Estimate, Std.Error = `Std. Error`, P.Value = `Pr(>|t|)`) %>%
  select(Subset, Effect, Estimate, `Std.Error`, P.Value)

h_results_df <- h_results_df %>% 
  rename(Estimate = Estimate, Std.Error = `Std. Error`, P.Value = `Pr(>|t|)`) %>%
  select(Subset, Effect, Estimate, `Std.Error`, P.Value)


# Initialize a list to store results
results_list_paired <- list()

# Define pairs of treatments to compare
treatment_pairs <- list(
  "CEM" = "CEM+IL15",
  "HUT78" = "HUT78+IL15",
  "K562" = "K562+IL15"
)
# Process each treatment pair
for (baseline in names(treatment_pairs)) {
  treated <- treatment_pairs[[baseline]]
  
  # Filter data for only the current pair of treatments
  pair_data <- TARA_Freq_DA[TARA_Freq_DA$Treatment %in% c(baseline, treated), ]
  
  # Create a factor to distinguish between baseline and treated groups
  pair_data$group <- factor(ifelse(pair_data$Treatment == baseline, "baseline", "treated"))
  names(pair_data)[names(pair_data) == "viral load"] <- "viral_load"
  # Check if there are enough data points to proceed
  if(nrow(pair_data) > 1) {
    # Design matrix including Timepoint as a factor and HIV status
    design <- model.matrix(~0+ group + Timepoint + HIV  +viral_load, data = pair_data)
    
    # Voom transformation
    v <- voom(t(pair_data[, !(names(pair_data) %in% c("PID", "HIV", "gender", "Timepoint","viral_load", "Treatment", "group"))]), 
              design, plot = FALSE)
    
    # Fit the linear model
    corfit <- duplicateCorrelation(v, design, block = pair_data$PID)
    fit <- lmFit(v, design, block = pair_data$PID, correlation = corfit$consensus)
    
    # Specify the correct contrast based on the baseline and treated groups
    contrast.matrix <- makeContrasts(grouptreated - groupbaseline, levels = design)
    
    # Apply contrasts
    fit2 <- contrasts.fit(fit, contrast.matrix)
    fit2 <- eBayes(fit2)
    
    # Store results, specifying treatment pair
    results_key <- paste(baseline, "vs", treated, sep="_")
    results_list_paired[[results_key]] <- topTable(fit2, adjust="BH", number=1000)
  }
}


## VOlcano Plots
results_list_paired$`CEM_vs_CEM+IL15`$feature<- rownames(results_list_paired$`CEM_vs_CEM+IL15`)
results_list_paired$`CEM_vs_CEM+IL15`$abs_logFC<- abs(results_list_paired$`CEM_vs_CEM+IL15`$logFC)

results_list_paired$`HUT78_vs_HUT78+IL15`$feature<- rownames(results_list_paired$`HUT78_vs_HUT78+IL15`)
results_list_paired$`HUT78_vs_HUT78+IL15`$abs_logFC<- abs(results_list_paired$`HUT78_vs_HUT78+IL15`$logFC)

results_list_paired$`K562_vs_K562+IL15`$feature<- rownames(results_list_paired$`K562_vs_K562+IL15`)
results_list_paired$`K562_vs_K562+IL15`$abs_logFC<- abs(results_list_paired$`K562_vs_K562+IL15`$logFC)


```

## Study Design and Aims

NK cells from HIV Exposed Infected (HEI) and HIV Exposed Uninfected (HEU) from the TARA cohort at Entry (1-2 months of age) and at 12 months of age were tested for functionality/ability to kill. The treatments they were exposed to were;

1.CEM
2.CEM+IL15
3.HUT78
4.HUT78+IL15
5.K562
6.K562+IL15

To deal with the paired nature of the data, at different timepoints, a mixed effects model was used to analyse the data, correcting for batch effect. It was run over all the data and also for each treatment seperately

## All Treatments{.tabset}

### Heatmap

```{r pressure, echo=FALSE}
TARA_Killing <- TARA_Killing %>%
  mutate(HIV_Timepoint = paste(HIV, Timepoint, sep = "_"))
heatmap_data <- TARA_Killing %>%
  group_by(Treatment, HIV_Timepoint) %>%
  summarise(mean_killing = mean(`specific killing`, na.rm = TRUE)) %>%
  ungroup()

ggplot(heatmap_data, aes(x = HIV_Timepoint, y = Treatment, fill = mean_killing)) +
  geom_tile() + # Creates the tiles for the heatmap
  scale_fill_viridis_c() + # Uses a color scale that's perceptually uniform
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # Rotates x-axis labels for readability
  labs(title = "Heatmap of Mean Specific Killing by Treatment and HIV/Timepoint",
       x = "HIV Status and Timepoint", y = "Treatment", fill = "Mean Specific Killing")

```

### Mixed Effects Model Summary

```{r}
summary(TARA_Killing_model)
```

### Specific Killing {.tabset}

#### Specific Killing

```{r}
ggplot(TARA_Killing, aes(x = Timepoint, y = `specific killing`, color = HIV, group=PID)) +
  geom_line(aes(linetype = HIV)) + # Different line types for HIV status
  geom_point() + # Different shapes for HIV status
  facet_wrap(~ Treatment, scales = "free_y") + # Separate plot for each treatment
  theme_minimal() +
  labs(title = "Predicted Specific Killing across Treatments, Timepoints, and HIV Status",
       y = "Specific Killing", x = "Timepoint") +
  scale_color_brewer(palette = "Set1") # Using a color palette for treatments

```

#### Predicted Killing

```{r}
ggplot(TARA_Killing, aes(x = Timepoint, y = predicted_killing, color = HIV, group=PID)) +
  geom_line(aes(linetype = HIV)) + # Different line types for HIV status
  geom_point() +
  facet_wrap(~ Treatment, scales = "free_y") + # Separate plot for each treatment
  theme_minimal() +
  labs(title = "Predicted Specific Killing across Treatments, Timepoints, and HIV Status",
       y = "Predicted Specific Killing", x = "Timepoint") +
  scale_color_brewer(palette = "Set1")

```

### Estimated Means Pairwise Comparison {.tabset}

HIV, Treatment: These indicate the subgroup for which the comparison is made. For example, "HIV = HEU, Treatment = CEM" refers to participants who are HIV positive under the CEM treatment.

Timepoint_pairwise: This specifies the comparison being made, here between "Entry" and "12" timepoints.

Non-Pairwise EMMs Interpretation:
Positive EMM at "12": Indicates that the adjusted mean value of your outcome variable (e.g., specific killing) is positive at the 12-month timepoint. This value is an estimate that accounts for other factors in your model.
Negative EMM at "Entry": Suggests that the adjusted mean value of your outcome variable at the entry timepoint is negative. Again, this is an adjusted estimate considering the model's covariates.

Pairwise Comparisons Interpretation:
Negative Estimate for "Entry - 12" Comparison: In pairwise comparisons, a negative estimate indicates that the mean value of the outcome variable at the first timepoint ("Entry") is lower than at the second timepoint ("12"). Essentially, this tells you there's an increase from "Entry" to "12". The interpretation of the sign here depends on how the comparison is framed.

SE (Standard Error): Indicates the precision of the estimate; a smaller SE suggests a more precise estimate.

df (Degrees of Freedom): Reflects the sample size and complexity of the model; more degrees of freedom generally indicate a larger sample size or less complex model.

t.ratio: The ratio of the estimate to its standard error. A larger absolute value of the t-ratio indicates a stronger evidence against the null hypothesis (no difference).

p.value: The probability of observing the data (or something more extreme) if the null hypothesis were true. A small p-value (e.g., < 0.05) suggests that the observed difference is unlikely to have occurred by chance.

Significance: A summary of the p-value, often marked with asterisks to indicate levels of significance (e.g., "***" for p < 0.001).

#### Timepoint {.tabset}

##### Simple {.tabset}

###### Summary

```{r}
emms_treatment <- emmeans(TARA_Killing_model, specs =  ~ Timepoint | HIV*Treatment)
# Perform pairwise comparisons for each treatmente
comparisons_treatment <- contrast(emms_treatment)
comparisons_df <- as.data.frame(summary(comparisons_treatment))
comparisons_df$Significance <- ifelse(comparisons_df$p.value < 0.001, '***',
                                      ifelse(comparisons_df$p.value < 0.01, '**',
                                             ifelse(comparisons_df$p.value < 0.05, '*', 'ns')))

comparisons_df
```

###### Plot

```{r fig.width=6, fig.height=18}
#### Plot

plot(comparisons_treatment)
```

##### Pairwise Timepoint {.tabset}

###### Summary

```{r}
emms_treatment <- emmeans(TARA_Killing_model, specs =  ~ Timepoint | HIV*Treatment)
# Perform pairwise comparisons for each treatmente
comparisons_treatment <- contrast(emms_treatment, interaction = 'pairwise')
comparisons_df <- as.data.frame(summary(comparisons_treatment))
comparisons_df$Significance <- ifelse(comparisons_df$p.value < 0.001, '***',
                                      ifelse(comparisons_df$p.value < 0.01, '**',
                                             ifelse(comparisons_df$p.value < 0.05, '*', 'ns')))

comparisons_df
```

###### Plot

```{r fig.width=6, fig.height=18}
#### Plot

plot(comparisons_treatment)
```


#### HIV Status {.tabset}

##### Simple {.tabset}

###### Summary

```{r}
emms_treatment <- emmeans(TARA_Killing_model, specs =  ~ HIV | Timepoint*Treatment)
# Perform pairwise comparisons for each treatmente
comparisons_treatment <- contrast(emms_treatment)
comparisons_df <- as.data.frame(summary(comparisons_treatment))
comparisons_df$Significance <- ifelse(comparisons_df$p.value < 0.001, '***',
                                      ifelse(comparisons_df$p.value < 0.01, '**',
                                             ifelse(comparisons_df$p.value < 0.05, '*', 'ns')))

comparisons_df
```

###### Plot

```{r fig.width=6, fig.height=18}
#### Plot

plot(comparisons_treatment)
```

##### Pairwise Timepoint {.tabset}

###### Summary

```{r}
emms_treatment <- emmeans(TARA_Killing_model, specs =  ~ HIV | Timepoint*Treatment)
# Perform pairwise comparisons for each treatmente
comparisons_treatment <- contrast(emms_treatment, interaction = 'pairwise')
comparisons_df <- as.data.frame(summary(comparisons_treatment))
comparisons_df$Significance <- ifelse(comparisons_df$p.value < 0.001, '***',
                                      ifelse(comparisons_df$p.value < 0.01, '**',
                                             ifelse(comparisons_df$p.value < 0.05, '*', 'ns')))

comparisons_df
```

###### Plot

```{r fig.width=6, fig.height=18}
#### Plot

plot(comparisons_treatment)
```

## Individual Treatments

This is the effect of different covariates on each NK subset, controlling for all other covariates

### Covariate Analysis Untreated {.tabset}

#### HIV Effect

```{r fig.height=15}
HIV_effects <- results_df %>% filter(Effect == "HIVHEU")
HIV_effects$Significance <- ifelse(HIV_effects$P.Value < 0.05, "*", "")
HIV_effects <- HIV_effects %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(HIV_effects), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of HIV Status (HEU Effect)", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```

#### Timepoint Effect

```{r fig.height=15}
Timepoint_effects <- results_df %>% filter(Effect == "TimepointEntry")
Timepoint_effects$Significance <- ifelse(Timepoint_effects$P.Value < 0.05, "*", "")
Timepoint_effects <- Timepoint_effects %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(Timepoint_effects), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of Timepoint (Entry Effect)", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```

#### Gender Effect

```{r fig.height=15}
Gender_effects <- results_df %>% filter(Effect == "gendermale")
Gender_effects$Significance <- ifelse(Gender_effects$P.Value < 0.05, "*", "")
Gender_effects <- Gender_effects %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(Gender_effects), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of Gender (Male Effect)", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```

#### HUT78 Specific Killing Effect

```{r fig.height=15}
HUT78 <- results_df %>% filter(Effect == "specific_killing_HUT78")
HUT78$Significance <- ifelse(HUT78$P.Value < 0.05, "*", "")
HUT78 <- HUT78 %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(HUT78), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of HUT78 Specific Killing", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```

#### K562 Specific Killing Effect

```{r fig.height=15}
K562 <- results_df %>% filter(Effect == "specific_killing_K562")
K562$Significance <- ifelse(K562$P.Value < 0.05, "*", "")
K562 <- K562 %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(K562), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of K562 Specific Killing", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```


### Covariate Analysis HUT78 {.tabset}

#### HIV Effect

```{r fig.height=15}
HIV_effects <- h_results_df %>% filter(Effect == "HIVHEU")
HIV_effects$Significance <- ifelse(HIV_effects$P.Value < 0.05, "*", "")
HIV_effects <- HIV_effects %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(HIV_effects), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of HIV Status (HEU Effect)", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```

#### Timepoint Effect

```{r fig.height=15}
Timepoint_effects <- h_results_df %>% filter(Effect == "TimepointEntry")
Timepoint_effects$Significance <- ifelse(Timepoint_effects$P.Value < 0.05, "*", "")
Timepoint_effects <- Timepoint_effects %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(Timepoint_effects), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of Timepoint (Entry Effect)", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```

#### Gender Effect

```{r fig.height=15}
Gender_effects <- h_results_df %>% filter(Effect == "gendermale")
Gender_effects$Significance <- ifelse(Gender_effects$P.Value < 0.05, "*", "")
Gender_effects <- Gender_effects %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(Gender_effects), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of Gender (Male Effect)", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```

#### HUT78 Specific Killing Effect

```{r fig.height=15}
HUT78 <- h_results_df %>% filter(Effect == "specific_killing_HUT78")
HUT78$Significance <- ifelse(HUT78$P.Value < 0.05, "*", "")
HUT78 <- HUT78 %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(HUT78), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of HUT78 Specific Killing", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```


### Covariate Analysis K562 {.tabset}

#### HIV Effect

```{r fig.height=15}
HIV_effects <- k_results_df %>% filter(Effect == "HIVHEU")
HIV_effects$Significance <- ifelse(HIV_effects$P.Value < 0.05, "*", "")
HIV_effects <- HIV_effects %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))


ggplot(filter_top_effects(HIV_effects), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of HIV Status (HEU Effect)", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```

#### Timepoint Effect

```{r fig.height=15}
Timepoint_effects <- k_results_df %>% filter(Effect == "TimepointEntry")
Timepoint_effects$Significance <- ifelse(Timepoint_effects$P.Value < 0.05, "*", "")
Timepoint_effects <- Timepoint_effects %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(Timepoint_effects), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of Timepoint (Entry Effect)", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```

#### Gender Effect

```{r fig.height=15}
Gender_effects <- k_results_df %>% filter(Effect == "gendermale")
Gender_effects$Significance <- ifelse(Gender_effects$P.Value < 0.05, "*", "")
Gender_effects <- Gender_effects %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(Gender_effects), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of Gender (Male Effect)", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```


#### K562 Specific Killing Effect

```{r fig.height=15}
K562 <- k_results_df %>% filter(Effect == "specific_killing_K562")
K562$Significance <- ifelse(K562$P.Value < 0.05, "*", "")
K562 <- K562 %>%
  mutate(Color = ifelse(Estimate > 0, "lightblue", "lightgreen"),
         Significance = ifelse(P.Value < 0.05, "*", ""))

ggplot(filter_top_effects(K562), aes(x = reorder(Subset, Estimate), y = Estimate, fill = Color)) +
  geom_col() +
  geom_errorbar(aes(ymin = Estimate - `Std.Error`, ymax = Estimate + `Std.Error`), width = 0.4) +
  geom_text(aes(label = Significance), vjust = -0.5, colour = "red") +
  scale_fill_identity() +
  coord_flip() +
  labs(title = "Effect of K562 Specific Killing", x = "Subsets", y = "Effect Size") +
  theme_minimal() +
  guides(fill=FALSE) # Hide the legend for fill
```

## Effect of IL15 {.tabset}

### CEM

```{r}
CEM_volcano_plot <- ggplot(results_list_paired$`CEM_vs_CEM+IL15`, aes(x = logFC, y = -log10(P.Value), text = paste("Cell Type:", feature, "<br>LogFC:", logFC, "<br>Adj. P-Val:", adj.P.Val))) +
  geom_point(aes(color = adj.P.Val < 0.05), alpha = 0.5) +
  scale_color_manual(values = c("TRUE" = "red", "FALSE" = "grey50")) +
  theme_minimal() +
  labs(title = "Volcano Plot NK Cell Fold Change  CEM+IL15 vs CEM", x = "Log2 Fold Change (CEM+IL15 vs CEM)", y = "-Log10 P-value")

CEM_volcano_plot <- ggplotly(CEM_volcano_plot, tooltip = "text")

CEM_volcano_plot
```

### HUT78

```{r}
HUT78_volcano_plot <- ggplot(results_list_paired$`HUT78_vs_HUT78+IL15`, aes(x = logFC, y = -log10(P.Value), text = paste("Cell Type:", feature, "<br>LogFC:", logFC, "<br>Adj. P-Val:", adj.P.Val))) +
  geom_point(aes(color = adj.P.Val < 0.05), alpha = 0.5) +
  scale_color_manual(values = c("TRUE" = "red", "FALSE" = "grey50")) +
  theme_minimal() +
  labs(title = "Volcano Plot NK Cell Fold Change  HUT78+IL15 vs HUT78", x = "Log2 Fold Change (CEM+IL15 vs CEM)", y = "-Log10 P-value")

HUT78_volcano_plot <- ggplotly(HUT78_volcano_plot, tooltip = "text")

HUT78_volcano_plot
```

### K562

```{r}
K562_volcano_plot <- ggplot(results_list_paired$`K562_vs_K562+IL15`, aes(x = logFC, y = -log10(P.Value), text = paste("Cell Type:", feature, "<br>LogFC:", logFC, "<br>Adj. P-Val:", adj.P.Val))) +
  geom_point(aes(color = adj.P.Val < 0.05), alpha = 0.5) +
  scale_color_manual(values = c("TRUE" = "red", "FALSE" = "grey50")) +
  theme_minimal() +
  labs(title = "Volcano Plot NK Cell Fold Change  K562+IL15 vs K562", x = "Log2 Fold Change (K562+IL15 vs K562)", y = "-Log10 P-value")

K562_volcano_plot <- ggplotly(K562_volcano_plot, tooltip = "text")

K562_volcano_plot
```